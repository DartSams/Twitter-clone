<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% for i in data["post"] %}
        {% if i[3] != "" %}
            <title>{{i[0]}} on Twitter:"{{i[3]}}"</title>
        {% else %}
            <title>{{i[0]}}'s Post</title>
        {%endif%}
    {%endfor%}
    <link rel="stylesheet" href="{{url_for('static',filename='post.css')}}">
</head>
<body>
    <main>
        <h2 class="title" style="color: white;display: flex; justify-content: center;">Website Users</h2>
        <div class="container">
            <div class="navbar">
                <a href="/" class="flex-item"><span>Website Name</span></a>
                <a href="/" class="flex-item"><span>Home</span></a>
                <a href="/" class="flex-item">Shop</a>
                <a href="" class="flex-item">About Us</a>
                <a href="" class="flex-item">Contact</a>
                {% if "username" in session %}
                <!-- <div class="flex-item">
                    <img src="\static\w3lynx_200.png" alt="" style="width: 10%; height:10%;">
                    <a href="/profile" >{{session["username"]}}</a>
                    <a href="/logout">Logout</a>  
                </div> -->
                <a href="/{{session['username']}}" class="flex-item">{{session["username"]}}</a>
                {% elif "username" not in session %}
                <a href="/login" class="flex-item">Login</a>
                {% endif %}

                <!-- <div class="profile-bar">
                    <img src="\static\w3lynx_200.png" alt="" style="width: 10%; height:10%;" >
                    <a href="/profile" >{{session["username"]}}</a>
                    <a href="/logout" >Logout</a>  
                </div> -->
            </div>

            <!-- {{user_post}} -->

            <div class="post">
                {{user_post}}
                {%for i in data["post"]%}
                    <!-- {{session["username"]}} -->
                    <div class="post-detail">
                        {{i}}
                        {% if i[1] == data["post date"] %}
                            <p class="post-name">By <a href="/{{i[0]}}">{{i[0]}}</a> - {{i[2]}}
                                {% if session["username"] == i[0] or data["admin status"]%}
                                <a href="/clear/{{i[6]}}" style="float: right; text-decoration: none; color:white">delete post</a>
                                {% endif %}
                            </p>
                        {% else %}
                            <p class="post-name">By <a href="/{{i[0]}}">{{i[0]}}</a> - {{i[5]}}
                                {% if session["username"] == i[0] or data["admin status"]%}
                                <a href="/clear/{{i[6]}}" style="float: right; text-decoration: none; color:white">delete post</a>
                                {% endif %}
                            </p>

                        {%endif%}

                        {% if i[3] != None%}
                            <p class="post-body" id="{{i[6]}}">{{i[3]}}</p>
                        {%endif%}
                        
                        <div class="current-post-file">
                            {% if i[4] != None %}
                                {% if 'mp4' == i[4].split(".")[1] %}
                                    <video controls width="320" height="240">
                                        <source src="/static/preview_img/{{i[4].split('.')[0]}}.{{i[4].split('.')[1]}}" type="video/{{i[4].split('.')[1]}}">
                                    Your browser does not support the audio element.
                                    </video>

                                {%elif 'mp3' == i[4].split(".")[1]%}
                                    <audio controls width="320" height="240">
                                        <source src="/static/preview_img/{{i[4].split('.')[0]}}.{{i[4].split('.')[1]}}" type="audio/{{i[4].split('.')[1]}}">
                                    Your browser does not support the audio element.
                                    </audio>

                                {%endif%}

                                {% for pic_type in data["Allowed Extensions"] %}
                                    {% if pic_type == i[4].split(".")[1] %}
                                        <img src="/static/preview_img/{{i[4]}}" alt="">
                                        <!-- {{i[4]}} -->
                                    {%endif%}
                                    <!-- {{pic_type}} -->
                                {%endfor%}

                            {%endif%}
                        </div>
                        

                        <!-- <br> -->
                        <div class="post-buttons">
                           <!-- <form action=""  class="post-buttons"> -->
                            <a id="4" name="Reply" class="Reply" value="{{i[6]}}" href="{{i[6]}}"><img src="/static/buttons/reply1.png" alt="">Reply</a>  
                            <button id="4" name="Retweet" class="Retweet" value="{{i[6]}}"><img src="/static/buttons/retweet.png" alt="" onclick="retweet(id)" id="post:{{i[3]}}">Retweet</button> 
                            {% if like_lst %}
                                <!-- {{like_lst}} -->
                                {% if like_lst[1] == i[6] %}
                                    <!-- {{like_lst[1]}} -->
                                    {% if like_lst[0] == session["username"] %}
                                    <button id="4" name="UnLike" class="Like" value="{{i[6]}}"><img src="/static/buttons/unlike.png" alt="" onclick="changeLike(id)" id="unlike:{{i[6]}}">Like</button>  
                                        
                                    {% else %}
                                        <!-- {{like_lst}} -->
                                        <button id="4" name="Like" class="Like" value="{{i[6]}}"><img src="/static/buttons/like.png" alt="" onclick="changeLike(id)" id="like:{{i[6]}}">Like</button>  
                                        {%endif%}    
                                {% else %}
                                    <button id="4" name="Like" class="Like" value="{{i[6]}}"><img src="/static/buttons/like.png" alt="" onclick="changeLike(id)" id="like:{{i[6]}}">Like</button>  
                                {%endif%}
                            {% else %}
                                <button id="4" name="Like" class="Like" value="{{i[6]}}"><img src="/static/buttons/like.png" alt="" onclick="changeLike(id)" id="like:{{i[6]}}">Like</button>  
                            {%endif%}
                            <button id="4" name="Share" class="Share" value="{{i[6]}}"><img src="/static/buttons/black heart.png" alt="">Share</button>  
                        <!-- </form> --> 
                        </div>

                        
                    </div>
                    {%endfor%}

                    {% if "username" in session %}

                        <form action=""  method="POST" enctype=multipart/form-data>
                            <!-- <div class="create-post"> -->
                                <textarea name="comment-field" id="myComment" cols="50" rows="5" placeholder="Type Here"></textarea>
                                <div class="form-buttons">
                                    <input type="file" name="file" >
                                    <!-- <input type="submit" value="Post"> -->
                                    <button type="submit">Upload</button>
                                </div>
                            <!-- </div> -->

                        </form>
                        <button onclick="onNewComment()" style="width: 500px;color:black">Post</button>
                    {%endif%}


                    <h1>Comments</h1>
                    <div class="comment-list" id="comment-list">
                            {%for i in data["comments"] %}
                            <!-- {{session["username"]}} -->
                            <!-- <div style="color: blue;">Author:{{i[0]}}</div>
                            <div style="color: blue;">Post Date:{{i[1]}}</div>
                            <div style="color: blue;">Post Time:{{i[2]}}</div>
                            <div style="color: blue;">Post:{{i[3]}}</div>
                            <div style="color: blue;">Post File:{{i[4]}}</div>
                            <div style="color: blue;">Placeholder Date:{{i[5]}}</div>
                            <div style="color: blue;">Post ID:{{i[6]}}</div> -->
                            <div class="post-detail">
                                {% if i[1] == data["post date"] %}
                                    <p class="post-name">By <a href="/{{i[0]}}">{{i[0]}}</a> - {{i[2]}}</p>
                                {% else %}
                                    <p class="post-name">By {{i[0]}} - {{i[5]}}</p>
                                {%endif%}

                                <p class="post-body">{{i[3].capitalize()}}</p>
                                
                                {% if i[4] != None %}
                                    {% if 'mp4' == i[4].split(".")[1] %}
                                        <video controls>
                                            <source src="/static/preview_img/{{i[4].split('.')[0]}}.{{i[4].split('.')[1]}}" type="video/{{i[4].split('.')[1]}}">
                                        Your browser does not support the audio element.
                                        </video>

                                    {%elif 'mp3' == i[4].split(".")[1]%}
                                        <audio controls>
                                            <source src="/static/preview_img/{{i[4].split('.')[0]}}.{{i[4].split('.')[1]}}" type="audio/{{i[4].split('.')[1]}}">
                                        Your browser does not support the audio element.
                                        </audio>

                                    {%endif%}

                                    {% for pic_type in data["Allowed Extensions"] %}
                                        {% if pic_type == i[4].split(".")[1] %}
                                            <img src="/static/preview_img/{{i[4]}}" alt="" width="60" height="100">
                                        {%endif%}
                                    {%endfor%}
                                {%endif%}
                            </div>
                            
                        {%endfor%}

                        <div class="no-comments">
                            {% if not data["comments"] %}
                                <p style="color:white">
                                    {% with messages = get_flashed_messages()%}
                                        {% if messages %}
                                            {% for message in messages%}
                                                {{message}}
                                                <br>
                                                <br>
                                            {%endfor%}
                                        {%endif%}
                                    {%endwith%}
                                </p>
                            {%endif%}
                        </div>
                        
                    </div>
                    
            </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js" integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA==" crossorigin="anonymous"></script>

        <script type="text/javascript" charset="utf-8">
            var socket = io();
            var username = "{{session['username']}}"
            var all_post = "{{data['post']}}"
            // socket.emit("changeLike",{user:username})
            // socket.on('onConnect', function(data) {
            //     // console.log(`${data}`)
            //     for (let i = 0;i<data.length;i++) {
            //         // console.log(data[i])

            //         let ass = document.getElementById(data[i][1]);
            //         // console.log(ass.getElementsByTagName("*"))
            //     }
            // });

            socket.on("message",function(msg){
                // console.log(`${msg.comment}`)
                try {
                    let removeComments = document.querySelector(".no-comments")
                    removeComments.parentNode.removeChild(removeComments)
                } catch (error) {
                    console.error(error);
                    // expected output: ReferenceError: nonExistentFunction is not defined
                    // Note - error messages will vary depending on browser
                }
                

                var postDiv = document.createElement("div");
                postDiv.setAttribute("class","post-detail");
                // postDiv.innerHTML = msg.comment;
                postDiv.style.color = "white";


                var postHeader = document.createElement("a");
                postHeader.setAttribute("class","post-name");
                postHeader.setAttribute("href",`/${msg.author}`);
                // postDiv.setAttribute("id",`${msg.postID}`)

                postHeader.innerHTML = `By ${msg.author} - ${msg.post_time}`;
                postHeader.style.color = "white";
                postDiv.appendChild(postHeader);


                var post = document.createElement("p");
                post.setAttribute("class","post-body")
                // post.setAttribute("id",`${msg.postID}`)
                post.innerHTML = `${msg.comment}`
                postDiv.appendChild(post);


                document.getElementById("comment-list").prepend(postDiv); 
                document.getElementById('myComment').value = ''
    
            });

            socket.on("makeComment", function(data) {
                console.log(data)
            });

            function myFunction() {
                let send_message = document.getElementById("myPost").value;
                socket.emit("message",{message:send_message})
            };

            function changeLike(id) {
                let button = document.getElementById(id).id

                // console.log(button)
                let splitButton = button.split(":");
                // console.log(splitButton);
                var likeStatus = splitButton[0];
                var likeID = splitButton[1];
                // console.log("-"+likeID)

                if (likeStatus === "like") {
                    // console.log("works")
                    document.getElementById(id).src = "/static/buttons/unlike.png";
                    socket.emit("changeLike",{user:username,status:likeStatus,id:likeID})
                    // var likeStatus="unlike"
                    document.getElementById(id).id = `unlike:${likeID}`
                    // console.log(button)
                } else if (likeStatus === "unlike") {
                    document.getElementById(id).src = "/static/buttons/like.png";
                    socket.emit("changeLike",{user:username,status:likeStatus,id:likeID})
                    // var likeStatus="like"
                    document.getElementById(id).id = `like:${likeID}`
                    // console.log(button)
                }
            }

            function retweet(id) {
                let button = document.getElementById(`${id}`).id
                // console.log(buttond)
                let splitButton = button.split(":");
                let postMessage = splitButton[1]
                let socketType = "newComment"

                socket.emit("message",{message:postMessage,type:socketType})
            }
            
            function onNewComment() {
                let comment = document.getElementById("myComment").value
                let commentID = document.querySelector(".post-body").id
                let socketType = "newComment"
                console.log(comment,commentID)

                socket.emit("makeComment",{user:username,comment:comment,commentID:commentID,type:socketType})
                // socket.emit("message",{message:comment})

            }
        </script>
    </main>

</body>
</html>